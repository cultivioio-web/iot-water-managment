name: Deploy Static Frontend to AWS S3

on:
  push:
    branches: [ main ]
    paths:
      - 'website/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'website/**'
  # Manual trigger
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1          # Mumbai region
  S3_BUCKET: cultivio.io          # Must match domain name for S3 website hosting
  CLOUDFRONT_DIST_ID: ''          # Add after CloudFront setup (e.g., E1ABCDEF123456)
  WORKING_DIR: website
  DOMAIN: cultivio.io

jobs:
  validate:
    name: Validate HTML Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check HTML files exist
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“ Checking website files..."
          
          if [ ! -f "index.html" ]; then
            echo "âŒ Error: index.html not found!"
            exit 1
          fi
          
          echo "âœ… index.html found"
          
          # List all files
          echo ""
          echo "ğŸ“¦ Website contents:"
          find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.svg" -o -name "*.png" -o -name "*.jpg" | head -50
          
          # Calculate total size
          echo ""
          echo "ğŸ“Š Total size:"
          du -sh .
      
      - name: Validate HTML syntax (optional)
        working-directory: ${{ env.WORKING_DIR }}
        continue-on-error: true
        run: |
          # Basic HTML validation using grep
          echo "ğŸ” Checking HTML structure..."
          
          for file in $(find . -name "*.html"); do
            if grep -q "<!DOCTYPE html>" "$file"; then
              echo "âœ… $file has DOCTYPE"
            else
              echo "âš ï¸  $file missing DOCTYPE"
            fi
          done

  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Sync files to S3
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸš€ Deploying to S3..."
          
          # Sync all files to S3
          aws s3 sync . s3://${{ env.S3_BUCKET }}/ \
            --delete \
            --cache-control "max-age=31536000" \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "*.md"
          
          # Set correct content types
          aws s3 cp s3://${{ env.S3_BUCKET }}/ s3://${{ env.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.html" \
            --content-type "text/html" \
            --metadata-directive REPLACE \
            --cache-control "no-cache"
          
          aws s3 cp s3://${{ env.S3_BUCKET }}/ s3://${{ env.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.css" \
            --content-type "text/css" \
            --metadata-directive REPLACE
          
          aws s3 cp s3://${{ env.S3_BUCKET }}/ s3://${{ env.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.js" \
            --content-type "application/javascript" \
            --metadata-directive REPLACE
          
          aws s3 cp s3://${{ env.S3_BUCKET }}/ s3://${{ env.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.json" \
            --content-type "application/json" \
            --metadata-directive REPLACE
          
          aws s3 cp s3://${{ env.S3_BUCKET }}/ s3://${{ env.S3_BUCKET }}/ \
            --recursive \
            --exclude "*" \
            --include "*.svg" \
            --content-type "image/svg+xml" \
            --metadata-directive REPLACE
          
          echo "âœ… Files synced to S3"
      
      - name: Invalidate CloudFront cache (if configured)
        if: env.CLOUDFRONT_DIST_ID != ''
        run: |
          echo "ğŸ”„ Invalidating CloudFront cache..."
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DIST_ID }} \
            --paths "/*"
          echo "âœ… CloudFront cache invalidated"
      
      - name: Deployment summary
        run: |
          echo ""
          echo "ğŸ‰ Deployment Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸŒ Website: https://${{ env.DOMAIN }}"
          echo "ğŸ“± Mobile App: https://${{ env.DOMAIN }}/app"
          echo ""
          echo "ğŸ“¦ S3 Direct: http://${{ env.S3_BUCKET }}.s3-website.${{ env.AWS_REGION }}.amazonaws.com"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Preview deployment for PRs
  preview:
    name: Preview Deployment Info
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Show preview info
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "ğŸ“‹ PR Preview - Files that will be deployed:"
          echo ""
          find . -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "  ğŸ“„ $file ($size)"
          done
          echo ""
          echo "â„¹ï¸  Merge to main branch to deploy to production"
