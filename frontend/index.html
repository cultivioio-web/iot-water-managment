<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíß IoT Water Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2196F3;
            --primary-dark: #1976D2;
            --secondary-cyan: #00BCD4;
            --accent-teal: #009688;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --error-red: #F44336;
            --bg-gradient-start: #E3F2FD;
            --bg-gradient-end: #B3E5FC;
            --card-bg: #FFFFFF;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.6s ease-out;
        }

        .header-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 400;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            animation: fadeInUp 0.6s ease-out;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 32px;
            margin-bottom: 24px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.18);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 2px solid var(--bg-gradient-start);
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #FAFAFA;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            background: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .checkbox-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        .checkbox-item {
            background: linear-gradient(135deg, #F5F5F5 0%, #FAFAFA 100%);
            padding: 14px 16px;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item:hover {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-color: var(--primary-blue);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            color: var(--primary-blue);
        }

        .btn-submit {
            width: 100%;
            padding: 16px 32px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-cyan) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        .status-message {
            margin-top: 24px;
            padding: 16px 20px;
            border-radius: 10px;
            font-weight: 500;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .status-success {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            color: #2E7D32;
            border-left: 4px solid var(--success-green);
        }

        .status-error {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            color: #C62828;
            border-left: 4px solid var(--error-red);
        }

        .info-badge {
            display: inline-block;
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            color: var(--primary-dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .unit-label {
            color: var(--text-secondary);
            font-weight: normal;
            font-size: 0.9rem;
        }

        .water-wave {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23B3E5FC" fill-opacity="0.4" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,149.3C960,160,1056,160,1152,138.7C1248,117,1344,75,1392,53.3L1440,32L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') repeat-x;
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            .header-title {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .checkbox-container {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="water-wave"></div>
    
    <div class="header">
        <h1 class="header-title">
            üíß IoT Water Management System
        </h1>
        <p class="header-subtitle">ESP32 Smart Configuration Dashboard</p>
    </div>

    <div class="container">
        <form id="setupForm">
            <!-- Node Duties Card -->
            <div class="card">
                <h2 class="section-title">‚öôÔ∏è Node Duties Configuration</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Select all duties that this node will perform
                </p>
                <div class="checkbox-container">
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="1" id="duty1">
                        <label for="duty1">üíß Water Level Measurement</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="2" id="duty2">
                        <label for="duty2">üèõÔ∏è Government Water Detection</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="4" id="duty3">
                        <label for="duty3">üß† Decision Making</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="8" id="duty4">
                        <label for="duty4">‚ö° Govt Water Pump Control</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="16" id="duty5">
                        <label for="duty5">üö® Emergency Pump Control</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="32" id="duty6">
                        <label for="duty6">üîî Alert System</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" name="duties" value="64" id="duty7">
                        <label for="duty7">üìä Status Display</label>
                    </div>
                </div>
            </div>

            <!-- Tank Configuration Card -->
            <div class="card">
                <h2 class="section-title">üõ¢Ô∏è Tank Configuration</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="tankHeight">
                            Tank Height <span class="unit-label">(cm)</span>
                        </label>
                        <input type="number" id="tankHeight" name="tankHeight" class="form-input" 
                               value="200" step="1" min="50" max="500" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="tankDiameter">
                            Tank Diameter <span class="unit-label">(cm)</span>
                        </label>
                        <input type="number" id="tankDiameter" name="tankDiameter" class="form-input" 
                               value="150" step="1" min="50" max="500" required>
                    </div>
                </div>
            </div>

            <!-- Season & Thresholds Card -->
            <div class="card">
                <h2 class="section-title">üå¶Ô∏è Season & Thresholds</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="season">
                            Current Season <span class="info-badge">Active</span>
                        </label>
                        <select id="season" name="season" class="form-select" required>
                            <option value="0">‚òÄÔ∏è Dry Season</option>
                            <option value="1">üåßÔ∏è Monsoon Season</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="powerSource">
                            Power Source
                        </label>
                        <select id="powerSource" name="mainsPower" class="form-select" required>
                            <option value="true">üîå Mains Power</option>
                            <option value="false">üîã Battery Power</option>
                        </select>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="emergencyThresholdDry">
                            Emergency Threshold - Dry <span class="unit-label">(%)</span>
                        </label>
                        <input type="number" id="emergencyThresholdDry" name="emergencyThresholdDry" 
                               class="form-input" value="10" step="0.5" min="0" max="100" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="emergencyThresholdMonsoon">
                            Emergency Threshold - Monsoon <span class="unit-label">(%)</span>
                        </label>
                        <input type="number" id="emergencyThresholdMonsoon" name="emergencyThresholdMonsoon" 
                               class="form-input" value="15" step="0.5" min="0" max="100" required>
                    </div>
                </div>
            </div>

            <!-- Wait Times Card -->
            <div class="card">
                <h2 class="section-title">‚è±Ô∏è Government Water Wait Times</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="govtWaterWaitDry">
                            Dry Season Wait Time <span class="unit-label">(hours)</span>
                        </label>
                        <input type="number" id="govtWaterWaitDry" name="govtWaterWaitDry" 
                               class="form-input" value="2" step="0.5" min="0" max="24" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="govtWaterWaitMonsoon">
                            Monsoon Wait Time <span class="unit-label">(hours)</span>
                        </label>
                        <input type="number" id="govtWaterWaitMonsoon" name="govtWaterWaitMonsoon" 
                               class="form-input" value="4" step="0.5" min="0" max="24" required>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="card">
                <button type="submit" class="btn-submit">
                    üíæ Save Configuration & Start System
                </button>
                <div id="status" class="status-message"></div>
            </div>
        </form>
    </div>

    <script>
        // Load current configuration on page load
        async function loadConfiguration() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Populate form fields
                document.getElementById('season').value = config.season || 0;
                document.getElementById('tankHeight').value = config.tankHeight || 200;
                document.getElementById('tankDiameter').value = config.tankDiameter || 150;
                document.getElementById('emergencyThresholdDry').value = config.emergencyThresholdDry || 10;
                document.getElementById('emergencyThresholdMonsoon').value = config.emergencyThresholdMonsoon || 15;
                document.getElementById('govtWaterWaitDry').value = config.govtWaterWaitHoursDry || 2;
                document.getElementById('govtWaterWaitMonsoon').value = config.govtWaterWaitHoursMonsoon || 4;
                document.getElementById('powerSource').value = (config.mainsPower !== undefined) ? config.mainsPower.toString() : 'true';

                // Set duty checkboxes
                const duties = config.duties || 0;
                for (let i = 1; i <= 7; i++) {
                    const checkbox = document.getElementById(`duty${i}`);
                    const bit = parseInt(checkbox.value);
                    checkbox.checked = (duties & bit) !== 0;
                }
            } catch (error) {
                console.error('Failed to load configuration:', error);
                showStatus('Warning: Could not load existing configuration. Using defaults.', false);
            }
        }

        // Show status message
        function showStatus(message, isSuccess) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status-message ' + (isSuccess ? 'status-success' : 'status-error');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (isSuccess) {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Handle form submission
        document.getElementById('setupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitButton = e.target.querySelector('.btn-submit');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.innerHTML = 'Saving Configuration...<span class="loading"></span>';
            submitButton.disabled = true;

            const formData = new FormData(e.target);

            // Convert checkbox array to bitwise OR
            let dutiesValue = 0;
            for (let i = 1; i <= 7; i++) {
                const checkbox = document.getElementById(`duty${i}`);
                if (checkbox.checked) {
                    dutiesValue |= parseInt(checkbox.value);
                }
            }

            // Create configuration object
            const data = {
                duties: dutiesValue,
                season: parseInt(formData.get('season')),
                tankHeight: parseFloat(formData.get('tankHeight')),
                tankDiameter: parseFloat(formData.get('tankDiameter')),
                emergencyThresholdDry: parseFloat(formData.get('emergencyThresholdDry')),
                emergencyThresholdMonsoon: parseFloat(formData.get('emergencyThresholdMonsoon')),
                govtWaterWaitDry: parseFloat(formData.get('govtWaterWaitDry')),
                govtWaterWaitMonsoon: parseFloat(formData.get('govtWaterWaitMonsoon')),
                mainsPower: formData.get('mainsPower') === 'true'
            };

            try {
                const response = await fetch('/configure', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('‚úÖ Configuration saved successfully! System will restart in autonomous mode.', true);
                } else {
                    showStatus('‚ùå Error: ' + (result.error || 'Failed to save configuration'), false);
                }
            } catch (error) {
                showStatus('‚ùå Network error: ' + error.message + '. Please check ESP32 connection.', false);
            } finally {
                // Restore button state
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // Load configuration when page loads
        window.addEventListener('DOMContentLoaded', loadConfiguration);
    </script>
</body>
</html>
