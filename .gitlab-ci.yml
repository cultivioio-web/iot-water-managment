# ============================================================================
# Cultivio AquaSense - GitLab CI/CD Pipeline
# ============================================================================
# This pipeline handles:
#   - ESP32-H2 Firmware builds (ESP-IDF)
#   - Website static deployment
#   - Native tests
#   - Release management
# ============================================================================

stages:
  - test
  - build
  - deploy
  - release

# ----------------------------------------------------------------------------
# Global Variables
# ----------------------------------------------------------------------------
variables:
  ESP_IDF_VERSION: "v5.2"
  FIRMWARE_DIR: "firmware/unified"
  WEBSITE_DIR: "apps/website"
  
# ----------------------------------------------------------------------------
# Cache Configuration
# ----------------------------------------------------------------------------
.esp_idf_cache: &esp_idf_cache
  cache:
    key: esp-idf-${ESP_IDF_VERSION}
    paths:
      - ~/.espressif/
      - firmware/unified/build/
    policy: pull-push

# ----------------------------------------------------------------------------
# Stage: Test
# ----------------------------------------------------------------------------

# Native unit tests (runs on any machine, no ESP32 required)
native_tests:
  stage: test
  image: node:20-alpine
  script:
    - cd firmware/test_native
    - echo "Running native tests..."
    - node test_all.js
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  tags:
    - docker

# Lint firmware code
firmware_lint:
  stage: test
  image: ubuntu:22.04
  before_script:
    - apt-get update && apt-get install -y cppcheck
  script:
    - echo "Linting firmware code..."
    - cppcheck --enable=all --error-exitcode=1 
        --suppress=missingIncludeSystem 
        firmware/unified/main/
        firmware/shared/
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
  tags:
    - docker

# Website HTML/CSS validation
website_lint:
  stage: test
  image: node:20-alpine
  script:
    - cd ${WEBSITE_DIR}
    - echo "Checking website files..."
    - find . -name "*.html" -type f | head -20
    - echo "Website lint passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  tags:
    - docker

# ----------------------------------------------------------------------------
# Stage: Build
# ----------------------------------------------------------------------------

# Build ESP32-H2 Unified Firmware
build_firmware:
  stage: build
  image: espressif/idf:${ESP_IDF_VERSION}
  <<: *esp_idf_cache
  script:
    - cd ${FIRMWARE_DIR}
    - echo "Setting target to ESP32-H2..."
    - idf.py set-target esp32h2
    - echo "Building firmware..."
    - idf.py build
    - echo "Build complete!"
    - ls -la build/*.bin
  artifacts:
    name: "firmware-${CI_COMMIT_SHORT_SHA}"
    paths:
      - firmware/unified/build/*.bin
      - firmware/unified/build/bootloader/*.bin
      - firmware/unified/build/partition_table/*.bin
      - firmware/unified/build/flasher_args.json
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG
  tags:
    - docker

# Build website (prepare for deployment)
build_website:
  stage: build
  image: node:20-alpine
  script:
    - cd ${WEBSITE_DIR}
    - echo "Preparing website for deployment..."
    # Add any build steps here (minification, etc.)
    - mkdir -p ../../public
    - cp -r . ../../public/
  artifacts:
    paths:
      - public/
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG
  tags:
    - docker

# ----------------------------------------------------------------------------
# Stage: Deploy
# ----------------------------------------------------------------------------

# Deploy website to GitLab Pages
pages:
  stage: deploy
  script:
    - echo "Deploying to GitLab Pages..."
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  needs:
    - build_website
  tags:
    - docker

# Deploy to staging (AWS/Custom server)
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
  script:
    - echo "Deploying to staging environment..."
    # Add your deployment commands here
    # Example: rsync, scp, aws cli, etc.
    - echo "Staging deployment complete!"
  environment:
    name: staging
    url: https://staging.cultivio.in
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual
  tags:
    - docker

# Deploy to production
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl openssh-client
  script:
    - echo "Deploying to production..."
    # Add your production deployment commands here
    - echo "Production deployment complete!"
  environment:
    name: production
    url: https://cultivio.in
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
  needs:
    - build_firmware
    - build_website
  tags:
    - docker

# ----------------------------------------------------------------------------
# Stage: Release
# ----------------------------------------------------------------------------

# Create release with firmware binaries
create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release ${CI_COMMIT_TAG}..."
  release:
    tag_name: ${CI_COMMIT_TAG}
    name: "Release ${CI_COMMIT_TAG}"
    description: |
      ## Cultivio AquaSense ${CI_COMMIT_TAG}
      
      ### Firmware
      - Unified firmware for ESP32-H2
      - Compatible with Sensor, Controller, and Router nodes
      
      ### Downloads
      - `firmware.bin` - Main application binary
      - `bootloader.bin` - Bootloader binary
      - `partition-table.bin` - Partition table
      
      ### Flashing
      ```bash
      esptool.py --chip esp32h2 write_flash 0x0 bootloader.bin 0x8000 partition-table.bin 0x10000 firmware.bin
      ```
    assets:
      links:
        - name: "Firmware Binary"
          url: "${CI_PROJECT_URL}/-/jobs/artifacts/${CI_COMMIT_TAG}/raw/firmware/unified/build/unified.bin?job=build_firmware"
          filepath: "/binaries/unified.bin"
          link_type: other
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  needs:
    - build_firmware
  tags:
    - docker

# ----------------------------------------------------------------------------
# Scheduled Jobs
# ----------------------------------------------------------------------------

# Nightly build (optional - uncomment to enable)
# nightly_build:
#   stage: build
#   extends: build_firmware
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "schedule"
#   tags:
#     - docker

